
在 Java 中，锁的状态分为4种，分别是无锁状态、偏向锁状态、轻量级锁状态 和 重量级锁状态。在 Java 中，Mark Word 的低两位用于表示锁的状态，分别为 “01”（无锁状态）、“01”（偏向锁状态）、“00”（轻量级锁状态）、“10”（重量级锁状态）。由于无锁状态和偏向锁状态都是 “01”，所以在低三位引入偏向锁标记位，用 “0” 表示无锁，“1” 表示偏向
![[Pasted image 20240424160900.png]]

# 无锁
当一个线程第一次访问一个对象的同步块时，JVM会在对象头中设置该线程的Thread ID，并将对象头的状态位设置为 “偏向锁”。这个过程称为 ”偏向“，表示当前对象偏向于第一个访问它的线程

# 偏向锁
当一个 Synchronized 块被线程首次进入时，锁对象会进入偏向锁模式。

在偏向锁模式下，锁会偏向于第一个获取它的线程，JVM 会在对象头中记录该线程的 ID 作为偏向锁的持有者，并将对象头中的 Mark Word 中的一部分作为偏向锁标记。

在这种情况下，如果其他线程访问该对象，会先检查该对象的偏向锁标记，如果和自己的线程 ID 相同，则直接获得锁。如果不同，改对象的锁状态会升级到轻量级锁状态。

**触发条件**：首次进入 Synchronized 块时自动开启，假设 JVM 启动参数没有禁用偏向锁

# 轻量级锁
当有另一个线程尝试获取已被偏向的锁时，偏向锁会被撤销，锁会升级为轻量级锁。

在轻量级锁状态中，JVM为对象头中的 Mark Word预留了一部分空间，用于存储指向线程栈中锁记录的指针。

当一个线程尝试获取轻量级锁时，JVM的做法是：
1. 将对象头中的 Mark Word复制到线程栈中的锁记录（Lock Record）
	- 每个 Java 对象头部都有一个 Mark Word，它用于存储对象自身的运行时数据，如哈希码、锁状态信息、分代年龄等。当线程尝试获取轻量级锁时，JVM 会在当前线程的栈帧中创建一个锁记录空间，然后将对象中的 Mark Word 复制到这个锁记录中。这个复制的 Mark Word 被称为 “Displaced Mark Word”
2. 尝试通过CAS操作更新对象头的Mark Word
	- JVM 尝试使用 CAS 操作，将对象头的 Mark Word 更新为指向锁记录的指针。如果这个更新操作成功，那么这个线程就成功获取了这个对象的轻量级锁

如果替换成功，则改线程获取锁成功；如果失败，则表示已经有其他线程获取了锁，则该锁状态会升级到重量级锁状态

**触发条件**：当有另一个线程尝试获取已被偏向的锁时，偏向锁会升级为轻量级锁


# 重量级锁
当轻量级锁的 CAS 操作失败，即出现了实际的竞争，锁会进一步升级为重量级锁

当锁状态升级到重量级锁状态时，JVM会将该对象的锁变成一个重量级锁，并在对象头中记录指向等待队列的指针。

如果一个线程想要获取该对象的锁，则需要先进入等待队列，等待锁被释放。当锁被释放时，JVM 会从等待队列中选择一个线程唤醒，并将该线程的状态设置为 “就绪” 状态，然后等待该线程重新获取该对象的锁

**触发条件**：当轻量级锁的 CAS 操作失败，轻量级锁升级为重量级锁