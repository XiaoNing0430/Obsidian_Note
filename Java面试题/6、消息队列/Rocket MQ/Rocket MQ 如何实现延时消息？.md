
Rocket MQ是支持延时消息的，延时消息写入到 Broker 后，不会立刻被消费者消费，需要等待指定的时长后才可被消费处理，称为延时消息。

# Rocket MQ 5.0 之前

当消息发送到 Broker 后，Broker 会将消息根据延迟级别进行存储。

实现方式是：将消息先存储到内存中，然后使用 Timer 定时器进行消息的延迟，到达指定的时间后再存储到磁盘上，最后投递给消费者。

延迟消息并不是支持任意时长的延迟的，它只支持：1s 5s 10s 30s 1min 2min 3min 4min 5min 6min 7min 8min 9min 10min 20min 30min 1h 2h 这18个时长


# Rocket MQ 5.0

Rocket MQ 5.0 新增了基于时间轮的定时消息。

实现方式为：**基于时间轮的定时消息**。时间轮是一种高效的定时器算法，能够处理大量的定时任务，并且能够在O(1) 时间内找到下一个即将要执行的任务，因此能够提高消息的投递性能。

并且基于时间轮的定时消息能够支持更高想消息精度，可以 实现秒级、毫秒级甚至更小时间粒度的定时消息。

具体实现方式如下：
1. Rocket MQ 在 Broker 端使用一个时间轮来管理定时消息，将消息按照过期时间放置在不同的槽位中，这样可以大幅减少定时器任务的数量
2. 时间轮的每个槽位对应一个时间间隔，比如 1s、5s、10s 等，每次时间轮的滴答，槽位向前移动一个时间间隔
3. 当 Broker 接收到定时消息时，根据消息的过期时间计算出需要投递的槽位，并将消息放置到对应的槽位中
4. 当时间轮的滴答到消息的过期时间时，时间轮会将该槽位中所有消息投递给消费者